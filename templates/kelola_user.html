{% extends "base.html" %}

{% block title %}Kelola User{% endblock %}

{% block head_extra %}
<style>
  .user-card {
    @apply bg-white shadow-sm rounded-lg overflow-hidden hover:shadow-md transition-all duration-200;
  }
  
  .role-admin {
    @apply text-red-600;
  }
  
  .role-siswa {
    @apply text-green-600;
  }
</style>
{% endblock %}

{% block content %}
<div x-data="{ 
    showAddModal: false, 
    showEditModal: false,
    userId: null,
    username: '',
    role: 'siswa',
    searchQuery: ''
  }">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-900">
      <i class="fas fa-users mr-2 text-primary-500"></i> Kelola User
    </h1>
    <button @click="showAddModal = true" type="button" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
      <i class="fas fa-user-plus mr-2"></i> Tambah User
    </button>
  </div>

  <div class="bg-white shadow-sm rounded-lg overflow-hidden">
    <div class="border-b border-gray-200 bg-primary-600 px-4 py-4 sm:px-6">
      <h2 class="text-xl font-medium text-white">Daftar User ({{ users|length }})</h2>
    </div>
    
    <div class="px-4 py-5 sm:p-6">
      <!-- Search box -->
      <div class="mb-6">
        <div class="mt-1 relative rounded-md shadow-sm">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-search text-gray-400"></i>
          </div>
          <input x-model="searchQuery" type="text" 
                 class="focus:ring-primary-500 focus:border-primary-500 block w-full pl-10 sm:text-sm border-gray-300 rounded-md" 
                 placeholder="Cari username...">
        </div>
      </div>
      
      <!-- User cards grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% if users %}
          {% for user in users %}
          <div class="user-card" x-show="'{{ user.username|lower }}'.includes(searchQuery.toLowerCase()) || searchQuery === ''">
            <div class="border-b border-gray-200 px-4 py-4">
              <div class="flex justify-between items-start">
                <div>
                  <h3 class="text-lg font-medium text-gray-900">{{ user.username }}</h3>
                  <span class="text-sm {% if user.role == 'admin' %}role-admin{% else %}role-siswa{% endif %}">
                    <i class="fas {% if user.role == 'admin' %}fa-user-shield{% else %}fa-user-graduate{% endif %}"></i> 
                    {{ user.role|capitalize }}
                  </span>
                </div>
                <div class="flex space-x-2">
                  <button type="button" @click="
                      showEditModal = true;
                      userId = {{ user.id }};
                      username = '{{ user.username }}';
                      role = '{{ user.role }}';
                    " 
                    class="inline-flex items-center p-1.5 border border-transparent rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                    <i class="fas fa-edit"></i>
                  </button>
                  <a href="{{ url_for('hapus_user', id=user.id) }}" 
                    class="inline-flex items-center p-1.5 border border-transparent rounded-md shadow-sm text-white {% if user.id == session.get('user_id') %}bg-gray-400 cursor-not-allowed{% else %}bg-red-600 hover:bg-red-700{% endif %}"
                    {% if user.id != session.get('user_id') %}
                    onclick="return confirm('Apakah Anda yakin ingin menghapus user ini?');"
                    data-loading="true" data-loading-message="Menghapus user..."
                    {% endif %}>
                    <i class="fas fa-trash"></i>
                  </a>
                </div>
              </div>
            </div>
            <div class="px-4 py-4">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-gray-500">ID: {{ user.id }}</p>
                  {% if user.id == session.get('user_id') %}
                  <p class="text-sm text-primary-600"><i class="fas fa-check-circle"></i> Akun Aktif</p>
                  {% endif %}
                </div>
                {% if user.role == 'siswa' %}
                <a href="#" class="inline-flex items-center px-2.5 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                  <i class="fas fa-chart-line mr-1"></i> Lihat Hasil
                </a>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="col-span-3">
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
              <div class="flex">
                <div class="flex-shrink-0">
                  <i class="fas fa-info-circle text-blue-400"></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm text-blue-700">Belum ada user yang tersedia. Silakan tambahkan user baru.</p>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Add User Modal -->
  <div x-show="showAddModal" 
      class="fixed inset-0 overflow-y-auto z-50" 
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showAddModal = false"></div>

      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
        <div class="bg-primary-600 px-4 py-4 sm:px-6">
          <div class="flex justify-between items-center">
            <h3 class="text-lg leading-6 font-medium text-white">
              Tambah User Baru
            </h3>
            <button @click="showAddModal = false" type="button" class="text-white hover:text-gray-200 focus:outline-none">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <form id="addUserForm" action="{{ url_for('tambah_user') }}" method="post">
          <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
            <div class="space-y-4">
              <div>
                <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                <div class="mt-1 relative rounded-md shadow-sm">
                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-user text-gray-400"></i>
                  </div>
                  <input type="text" id="username" name="username" required
                    class="focus:ring-primary-500 focus:border-primary-500 block w-full pl-10 sm:text-sm border-gray-300 rounded-md">
                </div>
              </div>
              
              <div x-data="{ showPassword: false }">
                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                <div class="mt-1 relative rounded-md shadow-sm">
                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-lock text-gray-400"></i>
                  </div>
                  <input :type="showPassword ? 'text' : 'password'" id="password" name="password" required
                    class="focus:ring-primary-500 focus:border-primary-500 block w-full pl-10 pr-10 sm:text-sm border-gray-300 rounded-md">
                  <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                    <button type="button" @click="showPassword = !showPassword" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                      <i class="fas" :class="showPassword ? 'fa-eye-slash' : 'fa-eye'"></i>
                    </button>
                  </div>
                </div>
              </div>
              
              <div>
                <label for="role" class="block text-sm font-medium text-gray-700">Role</label>
                <div class="mt-1 relative rounded-md shadow-sm">
                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-user-tag text-gray-400"></i>
                  </div>
                  <select id="role" name="role" required
                    class="focus:ring-primary-500 focus:border-primary-500 block w-full pl-10 sm:text-sm border-gray-300 rounded-md">
                    <option value="admin">Admin</option>
                    <option value="siswa" selected>Siswa</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
            <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-600 text-base font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:ml-3 sm:w-auto sm:text-sm">
              <i class="fas fa-save mr-2"></i> Simpan User
            </button>
            <button @click="showAddModal = false" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
              Batal
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div x-show="showEditModal" 
      class="fixed inset-0 overflow-y-auto z-50" 
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showEditModal = false"></div>

      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
        <div class="bg-primary-600 px-4 py-4 sm:px-6">
          <div class="flex justify-between items-center">
            <h3 class="text-lg leading-6 font-medium text-white">
              Edit User
            </h3>
            <button @click="showEditModal = false" type="button" class="text-white hover:text-gray-200 focus:outline-none">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <form x-ref="editForm" :action="'{{ url_for('edit_user', id=0) }}'.replace('0', userId)" method="post">
          <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
            <div class="space-y-4">
              <div>
                <label for="edit_username" class="block text-sm font-medium text-gray-700">Username</label>
                <div class="mt-1 relative rounded-md shadow-sm">
                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-user text-gray-400"></i>
                  </div>
                  <input x-model="username" type="text" id="edit_username" name="username" required
                    class="focus:ring-primary-500 focus:border-primary-500 block w-full pl-10 sm:text-sm border-gray-300 rounded-md">
                </div>
              </div>
              
              <div x-data="{ showPassword: false }">
                <label for="edit_password" class="block text-sm font-medium text-gray-700">
                  Password <span class="text-gray-500 text-xs">(Kosongkan jika tidak ingin mengubah)</span>
                </label>
                <div class="mt-1 relative rounded-md shadow-sm">
                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-lock text-gray-400"></i>
                  </div>
                  <input :type="showPassword ? 'text' : 'password'" id="edit_password" name="password"
                    class="focus:ring-primary-500 focus:border-primary-500 block w-full pl-10 pr-10 sm:text-sm border-gray-300 rounded-md">
                  <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                    <button type="button" @click="showPassword = !showPassword" class="text-gray-400 hover:text-gray-500 focus:outline-none">
                      <i class="fas" :class="showPassword ? 'fa-eye-slash' : 'fa-eye'"></i>
                    </button>
                  </div>
                </div>
              </div>
              
              <div>
                <label for="edit_role" class="block text-sm font-medium text-gray-700">Role</label>
                <div class="mt-1 relative rounded-md shadow-sm">
                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-user-tag text-gray-400"></i>
                  </div>
                  <select x-model="role" id="edit_role" name="role" required
                    class="focus:ring-primary-500 focus:border-primary-500 block w-full pl-10 sm:text-sm border-gray-300 rounded-md">
                    <option value="admin">Admin</option>
                    <option value="siswa">Siswa</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
            <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-600 text-base font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:ml-3 sm:w-auto sm:text-sm">
              <i class="fas fa-save mr-2"></i> Simpan Perubahan
            </button>
            <button @click="showEditModal = false" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
              Batal
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block body_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Add loading indicator for form submission
  document.getElementById('addUserForm')?.addEventListener('submit', function() {
    showLoading('Menyimpan user baru...');
    updateProgress(50);
  });
  
  const editForm = document.getElementById('editUserForm');
  if (editForm) {
    editForm.addEventListener('submit', function() {
      showLoading('Menyimpan perubahan...');
      updateProgress(50);
    });
  }
});
</script>
{% endblock %} 